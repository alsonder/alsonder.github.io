name: Update Kompendie

on:
  push:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout website repo med fuld historik
      - name: Checkout website repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Hent hele historikken, s√• push kan lykkes

      # 2Ô∏è‚É£ Checkout kompendie repo (privat)
      - name: Checkout kompendie repo
        uses: actions/checkout@v3
        with:
          repository: alsonder/kompendie
          ref: main
          token: ${{ secrets.COMPENDIE_PAT }}
          path: kompendie

      # 3Ô∏è‚É£ Installer pandoc og LaTeX
      - name: Install pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc texlive-latex-base

      # 4Ô∏è‚É£ Forbered output-mapper
      - name: Prepare directories
        run: |
          rm -rf kompendie_html
          mkdir -p kompendie_html/chapters
          mkdir -p kompendie_html/sections
          mkdir -p assets/kompendie

      # 5Ô∏è‚É£ Konverter main.tex til HTML
      - name: Convert main.tex
        run: |
          pandoc kompendie/kompendie/main.tex -s -o kompendie_html/main.html

      # 6Ô∏è‚É£ Konverter f√∏rste niveau kapitler
      - name: Convert first-level chapters
        run: |
          for file in kompendie/kompendie/kapitler/*/*.tex; do
            base=$(basename "$file" .tex)
            pandoc "$file" -s -o "kompendie_html/chapters/$base.html"
          done

      # 7Ô∏è‚É£ Konverter underkapitler
      - name: Convert sub-chapters
        run: |
          for file in kompendie/kompendie/kapitler/*/*/*.tex; do
            base=$(basename "$file" .tex)
            pandoc "$file" -s -o "kompendie_html/sections/$base.html"
          done

      # 8Ô∏è‚É£ Kopier PDF (fra Overleaf output)
      - name: Copy PDF
        run: |
          cp kompendie/kompendie/output/*.pdf assets/kompendie/ || echo "No PDF found"

      # 9Ô∏è‚É£ Generer index.html med menu
      - name: Generate index
        run: |
          echo "<!DOCTYPE html><html><head><meta charset='utf-8'><title>Kompendie</title>" > kompendie_html/index.html
          echo "<style>body{display:flex;font-family:sans-serif;}nav{width:260px;padding:20px;background:#f5f5f5;height:100vh;overflow-y:auto;}iframe{flex:1;border:none;height:100vh;}</style></head><body>" >> kompendie_html/index.html
          echo "<nav><h2>Kapitelmenu</h2>" >> kompendie_html/index.html
          echo "<h3>Hovedkapitler</h3><ul>" >> kompendie_html/index.html
          for file in kompendie_html/chapters/*.html; do
            base=$(basename "$file" .html)
            echo "<li><a href='chapters/$base.html' target='kapitel'>$base</a></li>" >> kompendie_html/index.html
          done
          echo "</ul>" >> kompendie_html/index.html
          echo "<h3>Sektioner</h3><ul>" >> kompendie_html/index.html
          for file in kompendie_html/sections/*.html; do
            base=$(basename "$file" .html)
            echo "<li><a href='sections/$base.html' target='kapitel'>$base</a></li>" >> kompendie_html/index.html
          done
          echo "</ul>" >> kompendie_html/index.html
          echo "<p><a href='/assets/kompendie/kompendie.pdf' download>Download PDF</a></p>" >> kompendie_html/index.html
          echo "</nav>" >> kompendie_html/index.html
          echo "<iframe name='kapitel' src='main.html'></iframe></body></html>" >> kompendie_html/index.html

      # üîü Deploy med pull + rebase for at undg√• konflikter
      - name: Deploy to GitHub Pages
        run: |
          rm -rf kompendie
          mv kompendie_html kompendie
          
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          git add .
          
          if git diff --cached --quiet; then
            echo "No changes detected ‚Äì nothing to deploy"
            exit 0
          fi
          
          git commit -m "Auto-update kompendie ‚Äì $(date '+%Y-%m-%d %H:%M UTC')"

          # Safe force-push ‚Äì this is the gold standard for *.github.io deployments
          git push origin main --force-with-lease
