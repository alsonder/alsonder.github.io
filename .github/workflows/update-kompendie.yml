name: Update Kompendie

on:
  push:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout website repo med fuld historik
      - name: Checkout website repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Checkout det private kompendie repo
      - name: Checkout kompendie repo
        uses: actions/checkout@v3
        with:
          repository: alsonder/kompendie
          ref: main
          token: ${{ secrets.COMPENDIE_PAT }}
          path: kompendie

      # 3. Installer pandoc og LaTeX
      - name: Install pandoc & LaTeX
        run: sudo apt-get update && sudo apt-get install -y pandoc texlive-latex-base

      # 4. Forbered mapper
      - name: Prepare directories
        run: |
          rm -rf kompendie_html
          mkdir -p kompendie_html/chapters
          mkdir -p kompendie_html/sections
          mkdir -p assets/kompendie

      # 5. Konverter main.tex
      - name: Convert main.tex
        run: |
          pandoc kompendie/kompendie/main.tex -s -o kompendie_html/main.html

      # 6. Konverter kapitler (fÃ¸rste niveau)
      - name: Convert first-level chapters
        run: |
          for file in kompendie/kompendie/kapitler/*/*.tex; do
            base=$(basename "$file" .tex)
            pandoc "$file" -s -o "kompendie_html/chapters/$base.html"
          done

      # 7. Konverter sektioner/under-kapitler
      - name: Convert sub-chapters
        run: |
          for file in kompendie/kompendie/kapitler/*/*/*.tex; do
            base=$(basename "$file" .tex)
            pandoc "$file" -s -o "kompendie_html/sections/$base.html"
          done

      # 8. Kopier PDF fra Overleaf-output
      - name: Copy PDF
        run: |
          cp kompendie/kompendie/output/*.pdf assets/kompendie/ || echo "No PDF found"

      # 9. Generer index.html med menu
      - name: Generate index.html
        run: |
          echo "<!DOCTYPE html><html><head><meta charset='utf-8'><title>Kompendie</title>" > kompendie_html/index.html
          echo "<style>body{display:flex;font-family:sans-serif;}nav{width:260px;padding:20px;background:#f5f5f5;height:100vh;overflow-y:auto;position:fixed;}iframe{margin-left:280px;width:calc(100% - 280px);height:100vh;border:none;}</style></head><body>" >> kompendie_html/index.html
          echo "<nav><h2>Indhold</h2>" >> kompendie_html/index.html
          echo "<h3>Kapitler</h3><ul>" >> kompendie_html/index.html
          for file in kompendie_html/chapters/*.html; do
            [ -f "$file" ] || continue
            base=$(basename "$file" .html)
            echo "<li><a href='chapters/$base.html' target='kapitel'>$base</a></li>" >> kompendie_html/index.html
          done
          echo "</ul><h3>Sektioner</h3><ul>" >> kompendie_html/index.html
          for file in kompendie_html/sections/*.html; do
            [ -f "$file" ] || continue
            base=$(basename "$file" .html)
            echo "<li><a href='sections/$base.html' target='kapitel'>$base</a></li>" >> kompendie_html/index.html
          done
          echo "</ul>" >> kompendie_html/index.html
          echo "<p><a href='/assets/kompendie/kompendie.pdf' download>ðŸ“¥ Download PDF</a></p>" >> kompendie_html/index.html
          echo "</nav><iframe name='kapitel' src='main.html'></iframe></body></html>" >> kompendie_html/index.html

      # 10. Deploy â€“ med den magiske linje der fikser alt
      - name: Deploy to GitHub Pages
        run: |
          rm -rf kompendie
          mv kompendie_html kompendie
          
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          
          git add .
          
          if git diff --cached --quiet; then
            echo "Ingen Ã¦ndringer â€“ intet at deploye"
            exit 0
          fi
          
          git commit -m "Auto-update kompendie â€“ $(date -u '+%Y-%m-%d %H:%M UTC')"
          
          # Denne linje gÃ¸r at det virker HVER gang
          git push origin main --force-with-lease